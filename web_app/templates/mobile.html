<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AppliancesBazaar - Mobile</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Poppins', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background:#f7f7f9; color:#222; }
    .wrap { max-width: 520px; margin: 0 auto; padding: 20px 16px 40px; }
    header { text-align:center; padding: 24px 0 12px; }
    header img { max-width: 160px; height:auto; }
    h1 { font-size: 22px; margin: 16px 0 8px; font-weight: 600; }
    p.sub { margin: 0 0 16px; color:#555; }
    .card { background:#fff; border-radius:12px; box-shadow:0 6px 16px rgba(0,0,0,0.06); padding:16px; }
    .field { margin:12px 0 16px; }
    .label { font-size: 13px; color:#666; margin-bottom:6px; }
    input, select { width:100%; padding:12px 14px; border:1px solid #ddd; border-radius:10px; font-size:16px; outline:none; box-sizing: border-box; max-width: 100%; }
    input:focus, select:focus { border-color:#3498db; box-shadow: 0 0 0 3px rgba(52,152,219,0.15); }
    .row { display:flex; gap:10px; }
    .row > div { flex:1; }
    button.primary { width:100%; padding:12px 14px; background:#2ecc71; color:#fff; border:none; border-radius:10px; font-size:16px; font-weight:600; }
    button.primary:disabled { opacity:0.5; }
    button.secondary { width:100%; padding:12px 14px; background:#3498db; color:#fff; border:none; border-radius:10px; font-size:16px; font-weight:600; }
    .hidden { display:none; }
    .err { color:#c0392b; font-size: 13px; margin-top: 6px; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <img src="/static/AB-Logo.jpg" alt="AppliancesBazaar" />
      <h1>Welcome to AppliancesBazaar</h1>
      <p class="sub">Please enter your mobile number to continue.</p>
    </header>

    <!-- Step 1: Phone + OTP -->
    <section id="step1" class="card">
      <div class="field">
        <div class="label">Mobile Number</div>
        <input id="mobile" type="tel" inputmode="numeric" pattern="\\d*" maxlength="10" placeholder="Enter 10-digit number" />
        <div id="mobileErr" class="err hidden">Enter a valid 10-digit number</div>
      </div>
      <div class="row">
        <div>
          <button id="sendBtn" class="primary" disabled>Validate</button>
        </div>
      </div>

      <div id="otpBlock" class="hidden">
        <div class="field">
          <div class="label">Enter OTP</div>
          <input id="otp" type="password" inputmode="numeric" pattern="\\d*" maxlength="6" placeholder="6-digit OTP" autocomplete="one-time-code" />
        </div>
        <div class="row">
          <div><button id="verifyBtn" class="secondary">Verify OTP</button></div>
        </div>
        <div id="otpErr" class="err hidden">Invalid OTP. Please try again.</div>
      </div>
    </section>

    <!-- Step 2: Profile Form -->
    <section id="step2" class="card hidden">
      <form id="profileForm" method="POST" action="/submit">
        <div class="field">
          <div class="label">Name</div>
          <input name="name" id="name" type="text" placeholder="Your full name" required />
        </div>
        <div class="field">
          <div class="label">Email</div>
          <input name="email" id="email" type="email" placeholder="you@example.com" required />
        </div>
        <div class="field">
          <div class="label">Address</div>
          <input name="address" id="address" type="text" placeholder="Street, area, building" required />
        </div>
        <div class="field">
          <div class="label">City</div>
          <input name="city" id="city" type="text" list="cityList" placeholder="Start typing city..." required />
          <datalist id="cityList">
            <option value="Bengaluru"></option>
            <option value="Chennai"></option>
            <option value="Hyderabad"></option>
            <option value="Mumbai"></option>
            <option value="Pune"></option>
            <option value="Delhi"></option>
          </datalist>
        </div>
        <div class="field">
          <div class="label">Configuration</div>
          <select name="bedrooms" id="bhk" required>
            <option value="2">2 BHK</option>
            <option value="3">3 BHK</option>
          </select>
        </div>
        <div class="field">
          <div class="label">Budget (₹)</div>
          <input type="range" id="budgetSlider" min="200000" max="1000000" step="10000" value="200000">
          <div style="margin-top:6px; font-weight:600;">₹ <span id="budgetOut">2,00,000</span></div>
          <input type="hidden" name="What is your overall budget for home appliances?" id="hiddenBudget" value="200000" />
        </div>
        <!-- Hidden fields map for submit route expectations -->
        <input type="hidden" name="use_default" value="1" />
        <input type="hidden" name="Mobile Number (Preferably on WhatsApp)" id="hiddenMobile" />
        <input type="hidden" name="E-mail" id="hiddenEmail" value="" />
        <input type="hidden" name="Number of bathrooms" value="2" />
        <input type="hidden" name="Adults (between the age 18 to 50)" value="2" />
        <input type="hidden" name="Elders (above the age 60)" value="0" />
        <input type="hidden" name="Kids (below the age 18)" value="0" />

        <div class="row">
          <div><button class="primary" type="submit">Submit</button></div>
        </div>
      </form>
    </section>
  </div>

  <script>
    const mobile = document.getElementById('mobile');
    const sendBtn = document.getElementById('sendBtn');
    const mobileErr = document.getElementById('mobileErr');
    const otpBlock = document.getElementById('otpBlock');
    const verifyBtn = document.getElementById('verifyBtn');
    const otpErr = document.getElementById('otpErr');
    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    const hiddenMobile = document.getElementById('hiddenMobile');
    const bhk = document.getElementById('bhk');
    const budgetSlider = document.getElementById('budgetSlider');
    const hiddenBudget = document.getElementById('hiddenBudget');
    const budgetOut = document.getElementById('budgetOut');

    function validatePhone(v){ return /^\d{10}$/.test(v); }

    mobile.addEventListener('input', () => {
      const v = mobile.value.replace(/\D/g, '').slice(0,10);
      if (mobile.value !== v) mobile.value = v;
      const ok = validatePhone(v);
      sendBtn.disabled = !ok;
      mobileErr.classList.toggle('hidden', ok);
    });

    // Keep hidden budget in sync with slider changes
    if (budgetSlider && hiddenBudget) {
      const updateBudget = () => {
        hiddenBudget.value = budgetSlider.value;
        if (budgetOut) budgetOut.textContent = Number(budgetSlider.value).toLocaleString('en-IN');
      };
      updateBudget();
      budgetSlider.addEventListener('input', updateBudget);
    }

    sendBtn.addEventListener('click', async () => {
      try {
        const res = await fetch('/send_otp', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({mobile: mobile.value})});
        const data = await res.json();
        if (data.success) { otpBlock.classList.remove('hidden'); }
        else { mobileErr.textContent = data.error || 'Failed to send OTP'; mobileErr.classList.remove('hidden'); }
      } catch(err){ mobileErr.textContent = 'Network error'; mobileErr.classList.remove('hidden'); }
    });

    verifyBtn.addEventListener('click', async () => {
      const otp = document.getElementById('otp').value.trim();
      try {
        const res = await fetch('/verify_otp', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({mobile: mobile.value, otp})});
        const data = await res.json();
        if (data.success) {
          hiddenMobile.value = mobile.value;
          const email = document.getElementById('email');
          const hiddenEmail = document.getElementById('hiddenEmail');
          if (email && hiddenEmail) hiddenEmail.value = email.value || '';
          // Persist budget from slider into hidden field
          if (budgetSlider && hiddenBudget) hiddenBudget.value = budgetSlider.value;
          step1.classList.add('hidden');
          step2.classList.remove('hidden');
        } else {
          otpErr.textContent = data.error || 'Invalid OTP'; otpErr.classList.remove('hidden');
        }
      } catch(err){ otpErr.textContent = 'Network error'; otpErr.classList.remove('hidden'); }
    });
  </script>
</body>
</html>


